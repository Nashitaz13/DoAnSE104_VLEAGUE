

# =============================================
# MVP COMPUTATION (Most Valuable Player)
# =============================================

def compute_mvp(
    *,
    session: Session,
    muagiai: str,
    limit: int = 10
) -> MVPResponse:
    """
    Compute MVP candidates based on player performance.
    
    Rating formula:
    - Goals: +3 points each
    - Assists: +2 points each
    - Matches played: +0.1 per match
    - Clean sheets (for goalkeepers): Not calculated due to lack of data
    
    Returns top N players sorted by average rating.
    """
    from collections import defaultdict
    from app.utils import normalize_event_type, logger
    import traceback
    
    try:
        # Verify season exists
        season = get_season_by_id(session=session, id=muagiai)
        if not season:
            return MVPResponse(
                muagiai=muagiai,
                mvp_candidates=[],
                generated_at=datetime.utcnow()
            )
        
        # Get all matches in season
        matches_stmt = select(LichThiDau.matran).where(LichThiDau.muagiai == muagiai)
        match_ids = list(session.exec(matches_stmt).all())
        
        if not match_ids:
            return MVPResponse(
                muagiai=muagiai,
                mvp_candidates=[],
                generated_at=datetime.utcnow()
            )
        
        # Initialize stats
        player_stats = defaultdict(lambda: {
            "goals": 0,
            "assists": 0,
            "matches_played": set(),
            "man_of_match": 0  # Placeholder - not tracked in current schema
        })
        player_clubs = {}  # macauthu -> maclb
        
        # Get all events in season
        events_stmt = select(SuKienTranDau).where(SuKienTranDau.matran.in_(match_ids))
        events = session.exec(events_stmt).all()
        
        # Process events
        for event in events:
            try:
                loaisukien = normalize_event_type(event.loaisukien)
            except ValueError:
                continue
            
            if loaisukien == "BanThang":
                if event.macauthu:
                    player_stats[event.macauthu]["goals"] += 1
                    if event.macauthu not in player_clubs and event.maclb:
                        player_clubs[event.macauthu] = event.maclb
                
                if event.cauthulienquan:
                    player_stats[event.cauthulienquan]["assists"] += 1
                    if event.cauthulienquan not in player_clubs and event.maclb:
                        player_clubs[event.cauthulienquan] = event.maclb
        
        # Get matches played from lineup
        lineup_stmt = select(
            DoiHinhXuatPhat.macauthu,
            DoiHinhXuatPhat.matran
        ).where(DoiHinhXuatPhat.matran.in_(match_ids))
        
        for macauthu, matran in session.exec(lineup_stmt).all():
            player_stats[macauthu]["matches_played"].add(matran)
        
        # Get player info (name, position)
        all_player_ids = list(player_stats.keys())
        if not all_player_ids:
            return MVPResponse(
                muagiai=muagiai,
                mvp_candidates=[],
                generated_at=datetime.utcnow()
            )
        
        players_stmt = select(CauThu).where(CauThu.macauthu.in_(all_player_ids))
        players_map = {p.macauthu: p for p in session.exec(players_stmt).all()}
        
        # Get club names
        club_ids = {val for val in player_clubs.values() if val}
        club_names = {}
        if club_ids:
            clubs_stmt = select(CauLacBo.maclb, CauLacBo.tenclb).where(
                CauLacBo.muagiai == muagiai,
                CauLacBo.maclb.in_(list(club_ids)),
            )
            club_names = {maclb: tenclb for maclb, tenclb in session.exec(clubs_stmt).all()}
        
        # Calculate ratings
        mvp_rows = []
        for macauthu, stats in player_stats.items():
            # Skip players with no activity
            if stats["goals"] == 0 and stats["assists"] == 0:
                continue
            
            matches = len(stats["matches_played"])
            if matches == 0:
                continue  # Cannot calculate rating without matches played
            
            # Simple rating formula
            rating = (
                (stats["goals"] * 3.0) +
                (stats["assists"] * 2.0) +
                (matches * 0.1)
            ) / matches  # Normalize by matches played
            
            player = players_map.get(macauthu)
            maclb = player_clubs.get(macauthu)
            
            mvp_rows.append({
                "macauthu": macauthu,
                "tencauthu": player.tencauthu if player else "Unknown",
                "maclb": maclb,
                "tenclb": club_names.get(maclb) if maclb else None,
                "vitrithidau": player.vitrithidau if player else None,
                "goals": stats["goals"],
                "assists": stats["assists"],
                "man_of_match": stats["man_of_match"],
                "average_rating": round(rating, 2),
                "matches_played": matches
            })
        
        # Sort by rating DESC, then goals DESC
        mvp_rows.sort(key=lambda x: (-x["average_rating"], -x["goals"], -x["assists"]))
        
        # Assign ranks and limit
        mvp_candidates = []
        current_rank = 1
        prev_rating = None
        
        for idx, row in enumerate(mvp_rows):
            if prev_rating is not None and row["average_rating"] < prev_rating:
                current_rank = idx + 1
            
            if idx < limit:
                mvp_candidates.append(MVPPlayerRow(
                    macauthu=row["macauthu"],
                    tencauthu=row["tencauthu"],
                    maclb=row["maclb"],
                    tenclb=row["tenclb"],
                    vitrithidau=row["vitrithidau"],
                    goals=row["goals"],
                    assists=row["assists"],
                    man_of_match=row["man_of_match"],
                    average_rating=row["average_rating"],
                    matches_played=row["matches_played"],
                    rank=current_rank
                ))
            else:
                break
            prev_rating = row["average_rating"]
        
        return MVPResponse(
            muagiai=muagiai,
            mvp_candidates=mvp_candidates,
            generated_at=datetime.utcnow()
        )
        
    except Exception as e:
        logger.error(f"Error computing MVP: {str(e)}")
        traceback.print_exc()
        return MVPResponse(
            muagiai=muagiai,
            mvp_candidates=[],
            generated_at=datetime.utcnow()
        )
